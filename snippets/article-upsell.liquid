{% assign articleUpsellProd = all_products[articleUpsellHandle] %}
<div class="article-upsell-wrapper">
  <div class="article-upsell">
    <div class="article-upsell-image">
      <a href="{{ articleUpsellProd.url }}" aria-label="article upsell">
        <img src="{{ articleUpsellProd.featured_image | img_url: 'x240' }}" alt="{{ articleUpsellProd.title }}">
      </a>
    </div>
    <div class="article-upsell-infos product-info">
      <div class="flex-box justify-between align-center">
        <a href="{{ articleUpsellProd.url }}" class="product-name">{{ articleUpsellProd.title }}</a>
        <span class="product-selling-price card-product-price">{{ articleUpsellProd.price | money }}</span>
      </div>
      <div class="article-product-desc">{{ articleUpsellProd.metafields.my_fields.extra_info }}</div>
      <div class="variants-wrapper">
        {% for variant in articleUpsellProd.variants %}
        <div class="variant-box {% if forloop.index == 1 %}variant-selected{% endif %} {% if product.has_only_default_variant %}no-disp{% endif %}" 
             data-index="{{ forloop.index }}"
             data-avaliable="{% if variant.available %}yes{% else %}no{% endif %}"
             data-sell-out-of-stock="{{ variant.inventory_policy }}"
             data-inventory-management="{{ variant.inventory_management }}"
             data-quantity="{{ variant.inventory_quantity }}"
             value="{{ variant.id }}"
             variant-name="{{ variant.title }}"
             data-compare="{{ variant.compare_at_price | money }}"
             data-price="{{ variant.price | money }}">{{ variant.title }}</div>
        {% endfor %}
      </div>
      <button class="btn addArticleUpsell">{{ 'products.product.add_to_cart' | t }}</button>
    </div>
  </div>
</div>

<script>
  
  function checkUpsellAvailability() {

    var selectedVariant = $(".article-upsell .variant-box.variant-selected").attr("variant-name");

    //Hide Unavailable variants
    $(".article-upsell .variant-box").each(function() {
      if($(this).attr("data-inventory-management") != "undefined" && $(this).attr("data-inventory-management") != null) {
      	if(($(this).attr("variant-name") == selectedVariant) && ($(this).attr("data-quantity") < parseInt($(".qty-number").text())) && ($(this).attr("data-sell-out-of-stock") == "deny")) {
          $(".addArticleUpsell").attr("disabled",true);
        }
        else if(($(this).attr("variant-name") == selectedVariant) && ($(this).attr("data-quantity") >= parseInt($(".qty-number").text()))) {
          $(".addArticleUpsell").attr("disabled",false);
        }  
	  }
	  else {
	  	  $(".addArticleUpsell").attr("disabled",false);
	  }
    });

  }
  
  $(document).ready(function() {
    checkUpsellAvailability();
  });
          
  $('.addArticleUpsell').click(function() {
    let renderedHtml;
    $('.drawer-cart').addClass('drawn');
    $('.background-drawer-cart').addClass('drawn');
    $('body').addClass('no-scroll');
    $('.cart-body').append(`<div class="load-container"><div class="load"></div></div>`);
    
    var formData = {
      'items': [{
        'id': parseInt($(".article-upsell .variant-box.variant-selected").attr("value")),
        'quantity': 1
      }],
      'sections': "dc-cart-drawer"
    };
    $.ajax({
      url: "/cart/add.js",
      method: "POST",
      dataType: "json",
      data: formData,
    })
    .done(function( data ) {
      console.log(data);
      
      $.ajax({
        url: "/cart.js",
        method: "GET",
        dataType: "json"
      })
      .done(function( cartData ) {
        $('.cart-items-total').text(cartData.item_count);
      })
      .fail(function(cartError) {
        console.log( cartError );
        $('.load-container').remove();
      });
      
      renderedHtml = getSectionInnerHTML(
        data.sections["dc-cart-drawer"],
        "#CartContainer"
      );
      $("#CartContainer").html(renderedHtml);
      if($('.drawer-cart-upsell').length > 0 && $('.upsell-product-wrap').length > 0) {
        $('.drawer-cart').addClass("with-upsell");
      }
      else {
        $('.drawer-cart').removeClass("with-upsell");
      }
      $('.load-container').remove();
    })
    .fail(function(error) {
      console.log(error);
      $('.load-container').remove();
    });
  });
</script>