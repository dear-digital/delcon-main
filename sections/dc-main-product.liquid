{{ 'dc-main-product.css' | asset_url | stylesheet_tag }}

{% assign current_variant = product.selected_or_first_available_variant %}
{% assign featured_image = current_variant.featured_image | default: product.featured_image %}

<div class="product marg-bottom-xl rel">
  <div class="container">
    <a href="{{ section.settings.terug_link }}" class="terug-btn"><span class="arrow-left">{% include "icon-arrow-sm" %}</span> {{ section.settings.terug_btn }}</a>
    <div class="flex-box justify-between align-start rel">
      <div class="card-product-image rel">

        <div class="product-slider-for rel" id="product-slider">
          {% for media in product.media %}
          {% if media.media_type == "video" %}
          <div class="product-img" data-vid="yes" href="{{ media | img_url: 'master' }}" data-caption="{{ product.title | escape  }}" data-width="{{media.width}}" data-height="{{media.height}}" itemprop="contentUrl" data-index="{{ forloop.index0 }}">
            <video autoplay muted playsinline="playsinline" preload="metadata" aria-label="{{ product.title }}" poster="{{ media.preview_image | img_url: 'x590' }}" loop>{% for video_source in media.sources %}<source src="{{ video_source.url }}" type="{{ video_source.mime_type }}">{% endfor %}</video>
          </div>  
          {% else %}
          <img src="{{ media | img_url: 'x590' }}" alt="{{ product.title | escape }}" loading="lazy">
          {% endif %}
          {% endfor %}
        </div>

        <div class="slider-nav no-t no-m {% for media in product.media %}{% if forloop.length < 8 %} no-transform{% endif %}{% endfor %}">
          {% for media in product.media %}          
          {% if media.media_type == "video" %}
          <video autoplay muted playsinline="playsinline" preload="metadata" aria-label="{{ product.title }}" poster="{{ media.preview_image | img_url: '200x' }}" loop>{% for video_source in media.sources %}<source src="{{ video_source.url }}" type="{{ video_source.mime_type }}">{% endfor %}</video>
          {% else %}
          <img src="{{ media | img_url: '100x' }}" alt="{{ product.title | escape }}" loading="lazy">
          {% endif %}
          {% endfor %}
        </div>

      </div>
      <div class="product-details" data-type="{{ product.type }}" data-handle="{{ product.handle }}">
        
        <div class="flex-box justify-between align-end">
          <h2 class="product-title">{{ product.title }}</h2>
          <p class="card-product-price product-price">{{ product.selected_or_first_available_variant.price | money }}</p>
        </div>
        
        {% for variant in product.variants %}
        <div class="variant-features {% if forloop.index != 1 %}no-disp{% endif %}" data-index="{{ forloop.index }}">
          {{ variant.metafields.my_fields.variant_desc }}
        </div>
        {% endfor %}
        
        <span class="variantType {% if product.has_only_default_variant %}no-disp{% endif %}">{{ section.settings.variant_type }}</span>

        <div class="variants-wrapper">
          {% for variant in product.variants %}
          <div class="variant-box {% if forloop.index == 1 %}variant-selected{% endif %} {% if product.has_only_default_variant %}no-disp{% endif %}" 
               data-index="{{ forloop.index }}" 
               data-avaliable="{% if variant.available %}yes{% else %}no{% endif %}"
               data-sell-out-of-stock="{{ variant.inventory_policy }}"
               data-inventory-management="{{ variant.inventory_management }}"
               data-quantity="{{ variant.inventory_quantity }}"
               value="{{ variant.id }}"
               variant-name="{{ variant.title }}"
               data-compare="{{ variant.compare_at_price | money }}"
               data-price="{{ variant.price | money }}">{{ variant.title }}</div>
          {% endfor %}
        </div>
        
        <script id="product-json" type="application/json">
        	{{ product.variants | json }}
        </script>
        
        <div class="flex-box justify-between">
          <div class="qty-wrapper" data-quantity="1">
            <span class="qty-btn symbol-minus minus">{% include "icon-minus" %}</span>
            <span class="qty-number">1</span>
            <span class="qty-btn symbol-plus plus">{% include "icon-plus" %}</span>
          </div>
          <button class="btn addToCart" id="AddtoCart">{{ section.settings.add_to_cart }}</button>
        </div>
        
        <span class="shipping-details">{{ section.settings.shipping_details }}</span>
        
        <div class="other-details">
          {% if product.metafields.my_fields.product_general %}
          <div class="product-faq">
            <h3 class="product-accordion sub-title">Omschrijving <span class="symbol">{% render "accordion-plus" %}</span></h3>
            <div class="panel"><p>{{ product.metafields.my_fields.product_general }}</p></div>
          </div>
          {% endif %}

          {% if product.metafields.my_fields.product_ingredients %}
          <div class="product-faq">
            <h3 class="product-accordion sub-title">IngrediÃ«nten en toevoegingen <span class="symbol">{% render "accordion-plus" %}</span></h3>
            <div class="panel"><p>{{ product.metafields.my_fields.product_ingredients }}</p></div>
          </div>
          {% endif %}

          {% if product.metafields.my_fields.product_required_qty %}
          <div class="product-faq">
            <h3 class="product-accordion sub-title">Hoeveel moet mijn hond eten? <span class="symbol">{% render "accordion-plus" %}</span></h3>
            <div class="panel"><p>{{ product.metafields.my_fields.product_required_qty }}</p></div>
          </div>
          {% endif %}
        </div>
        
      </div>
    </div>
  </div>
</div>

<script>
  
  $(document).ready(function() {
	checkAvailability();
  });
  
  function scrollProductImage() {
    
    var variantTitle = $(".variant-box.variant-selected").attr("variant-name");
    
    var x = JSON.parse($('#product-json').html());
    var w = x.find(item => {
		return item.public_title === variantTitle;
    });

    if(w.featured_image != null) {
      $('.product-slider').slick('slickGoTo', (parseInt(w.featured_image.position)-1), false);
    }
    
  }
  
  function checkAvailability() {

    var selectedVariant = $(".variant-box.variant-selected").attr("variant-name");

    //Hide Unavailable variants
    $(".variant-box").each(function() {
      if($(this).attr("data-inventory-management") != "undefined" && $(this).attr("data-inventory-management") != null) {
      	if(($(this).attr("variant-name") == selectedVariant) && ($(this).attr("data-quantity") < parseInt($(".qty-number").text())) && ($(this).attr("data-sell-out-of-stock") == "deny")) {
          $("#AddtoCart").attr("disabled",true);
          $("#AddtoCart").text("{{ section.settings.out_of_stock }}");
        }
        else if(($(this).attr("variant-name") == selectedVariant) && ($(this).attr("data-quantity") >= parseInt($(".qty-number").text()))) {
          $("#AddtoCart").attr("disabled",false);
          $("#AddtoCart").html("{{ section.settings.add_to_cart }}");
        }  
	  }
	  else {
	  	  $("#AddtoCart").attr("disabled",false);
          $("#AddtoCart").html("{{ section.settings.add_to_cart }}");
	  }
    });

  }
          
  $(".minus").click(function() {
    var currVal = parseInt($(".qty-number").text());
    var newVal;
    if((currVal-1) > 1) {
      newVal = currVal - 1;
      $(".minus").css("opacity", "1");
    }
    else {
      newVal = 1;
      $(".minus").css("opacity", "0.5");
    }
    $(".qty-number").text(newVal);
    $(".qty-wrapper").attr("data-quantity",newVal);
    checkAvailability();
  });
  
  
  $(".plus").click(function() {
    var currVal = parseInt($(".qty-number").text());
    var newVal = currVal + 1;
    $(".qty-number").text(newVal);
    $(".qty-wrapper").attr("data-quantity",newVal);
    $(".minus").css("opacity", "1");
    checkAvailability();
  });
  
  $('#AddtoCart').click(function() {
    let renderedHtml;
    $('.drawer-cart').addClass('drawn');
    $('.background-drawer-cart').addClass('drawn');
    $('body').addClass('no-scroll');
    $('.cart-body').append(`<div class="load-container"><div class="load"></div></div>`);
    
    var formData = {
      'items': [{
        'id': parseInt($(".variant-box.variant-selected").attr("value")),
        'quantity': parseInt($(".qty-number").text())
      }],
      'sections': "dc-cart-drawer"
    };
    $.ajax({
      url: "/cart/add.js",
      method: "POST",
      dataType: "json",
      data: formData,
    })
    .done(function( data ) {
      console.log(data);
      
      $.ajax({
        url: "/cart/cart.js",
        method: "POST",
        dataType: "json"
      })
      .done(function( cartData ) {
        $('.cart-items-total').text(cartData.item_count);
      })
      .fail(function(cartError) {
        console.log( cartError );
        $('.load-container').remove();
      });
      renderedHtml = getSectionInnerHTML(
        data.sections["dc-cart-drawer"],
        "#CartContainer"
      );
      $("#CartContainer").html(renderedHtml);
      if($('.drawer-cart-upsell').length > 0 && $('.upsell-product-wrap').length > 0) {
        $('.drawer-cart').addClass("with-upsell");
      }
      else {
        $('.drawer-cart').removeClass("with-upsell");
      }
      $('.load-container').remove();
    })
    .fail(function(error) {
      console.log(error);
      $('.load-container').remove();
    });
  });
          
  $(".product-accordion").click(function() {
    var acc1 = $(this).hasClass('faq-active')
    $(".product-accordion").each(function() {
      $(this).removeClass("faq-active");
      var panel = $(this).next()[0];
      panel.style.maxHeight = null;
    });
    if(acc1) {
      $(this).removeClass("faq-active")
      var panel = $(this).next()[0];
      panel.style.maxHeight = null;
    }
    else {
      $(this).addClass("faq-active")
      var panel = $(this).next()[0];
      panel.style.maxHeight = panel.scrollHeight + "px";
    } 
  });
  
</script>

{% schema %}
  {
    "name": "Delcon Main Product",
    "settings": [
		{
          "type": "text",
          "id": "terug_btn",
          "label": "Terug Button text",
		  "default": "terug naar honden"
        },
		{
          "type": "url",
          "id": "terug_link",
          "label": "Terug Button link"
        },
		{
          "type": "text",
          "id": "variant_type",
          "label": "Hoeveelheid text",
		  "default": "Hoeveelheid:"
        },
		{
          "type": "html",
          "id": "shipping_details",
          "label": "Free Shipping from text"
        },
		{
          "type": "text",
          "id": "out_of_stock",
          "label": "Out of Stock text",
		  "default": "Uitverkocht"
        },
		{
          "type": "text",
          "id": "add_to_cart",
          "label": "Add to Cart text",
		  "default": "AAN WINKELWAGEN TOEVOEGEN"
        }
	],
	"presets":[
      {
         "name":"Delcon Main Product"
      }
   ]
  }
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
{% endjavascript %}
